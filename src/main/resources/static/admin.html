<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Admin Dashboard</h1>

    <!-- Register Admin -->
    <h2>Register Admin</h2>
    <form id="registerAdminForm">
        <input id="adminName" name="name" placeholder="Name" required>
        <input id="adminEmail" name="email" placeholder="Email" required>
        <input id="adminPassword" name="password" type="password" placeholder="Password" required>
        <button type="submit">Register Admin</button>
    </form>
    <div id="adminMsg"></div>

    <!-- Edit Admin -->
    <div id="editAdminSection" style="display:none;">
        <h2>Edit Admin</h2>
        <form id="editAdminForm">
            <input type="hidden" id="editAdminId">
            <input id="editAdminName" name="name" placeholder="Name" required>
            <input id="editAdminEmail" name="email" placeholder="Email" required>
            <button type="submit">Save Admin</button>
        </form>
        <div id="editAdminMsg"></div>
    </div>

    <!-- Admins List -->
    <h2>All Admins</h2>
    <ul id="adminsList"></ul>

    <hr>

    <!-- Students Section -->
    <h2>All Students</h2>
    <ul id="studentsList"></ul>

    <!-- Edit Student -->
    <div id="editStudentSection" style="display:none;">
        <h2>Edit Student</h2>
        <form id="editStudentForm">
            <input type="hidden" id="editStudentId">
            <input id="editStudentName" name="name" placeholder="Name" required>
            <input id="editStudentEmail" name="email" placeholder="Email" required>
            <input id="editStudentRollNumber" name="rollNumber" placeholder="Roll Number" required>
            <input id="editStudentPhone" name="phone" placeholder="Phone" required>
            <input id="editStudentAddress" name="address" placeholder="Address" required>
            <button type="submit">Save Student</button>
        </form>
        <div id="editStudentMsg"></div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // Register Admin
        document.getElementById('registerAdminForm').onsubmit = async function(e) {
            e.preventDefault();
            const body = {
                name: adminName.value,
                email: adminEmail.value,
                password: adminPassword.value,
                role: "admin"
            };
            const res = await apiFetch('/api/admin/users/register-admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const msg = document.getElementById('adminMsg');
            if (res.ok) {
                msg.style.color = 'green';
                msg.textContent = 'Admin registered!';
                getAdmins();
            } else {
                const err = await res.text();
                msg.style.color = 'red';
                msg.textContent = err || 'Error registering admin.';
            }
        };

        // Get all admins
        async function getAdmins() {
            const res = await apiFetch('/api/admin/users');
            const admins = await res.json();
            const ul = document.getElementById('adminsList');
            ul.innerHTML = '';
            admins.forEach(a => {
                const li = document.createElement('li');
                li.innerHTML = `<b>${a.name}</b> (${a.email}) 
                    <button onclick="showEditAdmin(${a.id})">Edit</button>
                    <button onclick="deleteAdmin(${a.id})">Delete</button>`;
                ul.appendChild(li);
            });
        }

        // Show edit admin form
        async function showEditAdmin(id) {
            const res = await apiFetch(`/api/admin/users/${id}`);
            if (!res.ok) return;
            const a = await res.json();
            document.getElementById('editAdminId').value = a.id;
            document.getElementById('editAdminName').value = a.name;
            document.getElementById('editAdminEmail').value = a.email;
            document.getElementById('editAdminSection').style.display = '';
        }

        // Save admin (update)
        document.getElementById('editAdminForm').onsubmit = async function(e) {
            e.preventDefault();
            const id = editAdminId.value;
            const body = {
                name: editAdminName.value,
                email: editAdminEmail.value
            };
            const res = await apiFetch(`/api/admin/users/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const msg = document.getElementById('editAdminMsg');
            if (res.ok) {
                msg.style.color = 'green';
                msg.textContent = 'Admin updated!';
                getAdmins();
                editAdminSection.style.display = 'none';
            } else {
                msg.style.color = 'red';
                msg.textContent = await res.text() || 'Error updating admin.';
            }
        };

        // Delete admin
        async function deleteAdmin(id) {
            if (!confirm('Delete this admin?')) return;
            await apiFetch(`/api/admin/users/${id}`, { method: 'DELETE' });
            getAdmins();
        }

        // Get all students
        async function getStudents() {
            const res = await apiFetch('/api/students');
            const students = await res.json();
            const ul = document.getElementById('studentsList');
            ul.innerHTML = '';
            students.forEach(s => {
                const li = document.createElement('li');
                li.innerHTML = `<b>${s.name}</b> (${s.email}) [${s.rollNumber}] 
                    <button onclick="showEditStudent(${s.studentId})">Edit</button>
                    <button onclick="deleteStudent(${s.studentId})">Delete</button>`;
                ul.appendChild(li);
            });
        }

        // Show edit student form
        async function showEditStudent(id) {
            const res = await apiFetch(`/api/students/${id}`);
            if (!res.ok) return;
            const s = await res.json();
            document.getElementById('editStudentId').value = s.id;
            document.getElementById('editStudentName').value = s.name;
            document.getElementById('editStudentEmail').value = s.email;
            document.getElementById('editStudentRollNumber').value = s.rollNumber;
            document.getElementById('editStudentPhone').value = s.phone;
            document.getElementById('editStudentAddress').value = s.address;
            document.getElementById('editStudentSection').style.display = '';
        }

        // Save student (update)
        document.getElementById('editStudentForm').onsubmit = async function(e) {
            e.preventDefault();
            const id = editStudentId.value;
            const body = {
                name: editStudentName.value,
                email: editStudentEmail.value,
                rollNumber: editStudentRollNumber.value,
                phone: editStudentPhone.value,
                address: editStudentAddress.value,
                role: "student",
                password: "" // or fetch the old password if needed
            };
            const res = await apiFetch(`/api/students/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const msg = document.getElementById('editStudentMsg');
            if (res.ok) {
                msg.style.color = 'green';
                msg.textContent = 'Student updated!';
                getStudents();
                editStudentSection.style.display = 'none';
            } else {
                msg.style.color = 'red';
                msg.textContent = await res.text() || 'Error updating student.';
            }
        };

        // Delete student
        async function deleteStudent(id) {
            if (!confirm('Delete this student?')) return;
            await apiFetch(`/api/students/${id}`, { method: 'DELETE' });
            getStudents();
        }

        // Initial load
        getAdmins();
        getStudents();
    </script>
</body>
</html>
